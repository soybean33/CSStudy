## 3.3 프로세스와 스레드  
* 프로세스(process): 컴퓨터에서 실행되고 있는 프로그램, CPU 스케줄링의 대상이 되는 작업(task)이라는 용어와 거의 같은 의미로 쓰임  
* 스레드(thread): 프로세스 내 작업의 흐름  

프로그램이 메모리에 올라가면 프로세스가 되는 인스턴스화가 일어나고, 이후 운영체제의 CPU 스케줄링에 따라 CPU가 프로세스를 실행  

### 3.3.1 프로세스와 컴파일 과정  
프로세스는 프로그램이 메모리에 올라가 인스턴스화된 것  
컴파일러가 컴파일 과정을 통해 컴퓨터가 이해할 수 있는 기계어로 번역하여 실행할 수 있는 파일을 만듦  

#### 전처리  
소스 코드의 주석을 제거하고 #include 등 헤더 파일을 병합하여 매크로를 치환  

#### 컴파일러  
오류처리, 코드 최적화 작업을 하며 어셈블리어로 변환  

#### 어셈블러  
어셈블리어를 목적 코드(object code)로 변환  

#### 링커  
프로그램 내에 있는 **라이브러리** 함수 또는 다른 파일들과 목적 코드를 결합하여 실행 파일을 만듦  

##### 정적 라이브러리와 동적 라이브러리  
* 정적 라이브러리  
프로그램 빌드 시 라이브러리가 제공한느 모든 코드를 실행 파일에 넣는 방식으로 라이브러리를 쓰는 방법  
장점: 시스템 환경 등 외부 의존도가 낮음  
단점: 코드 중복 등 메모리 효율성이 떨어짐  
* 동적 라이브러리
프로그램 실행 시 필요할 때만 DLL 이라는 함수 정보를 참조하여 라이브러리를 쓰는 방법  
장점: 메모리 효율성  
단점: 외부 의존도가 높아짐  

### 3.3.2 프로세스의 상태  
프로세스의 상태는 여러 가지 상태 값을 갖음  

#### 생성 상태(create)  
프로세스가 생성된 상태를 의미하며 fork() 또는 exec() 함수를 통해 생성, 이때 PCB가 할당  
* fork()  
부모 프로세스의 주소 공간을 그대로 복사하며, 새로운 자식 프로세스를 생성  
주소 공간만 복사하고 부모 프로세스의 비동기 작업 등을 상속하지는 않음  
* exec()  
새롭게 프로세스를 생성하는 함수  

#### 대기 상태(ready)  
메모리 공간이 충분하면 메모리를 할당받고 아니면 아닌 상태로 대기  
CPU 스케줄러로부터 CPU 소유권이 넘어오기를 기다리는 상태  

#### 대기 중단 상태(ready suspended)  
메모리 부족으로 일시 중단된 상태  

#### 실행 상태(running)  
CPU 소유권과 메모리를 할당받고 인스트럭션을 수행 중인 상태  

#### 중단 상태(blocked)  
어떤 이벤트가 발생한 이후 기다리며 프로세스가 차단된 상태  
I/O 디바이스에 의한 인터럽트로 많이 발생  

#### 일시 중단 상태(block suspended)  
중단된 상태에서 프로세스가 실행되려고 했지만 메모리 부족으로 일시 중단된 상태  

#### 종료 상태(terminated)  
메모리와 CPU 소유권을 모두 놓고 가는 상태  
부모 프로세스가 자식 프로세스를 강제시키는 비자발적 종료(abort)로 종료되는 것도 있음  

### 3.3.3 프로세스의 메모리 구조  
운영체제는 프로세스에 적절한 메모리를 할당  
위에서부터 스택(stack), 힙(heap), 데이터 영역(BSS segment, Data segment), 코드 영역(code segment)로 나뉘어짐  
스택은 위 주소부터 할당되고, 힙은 아래 주소부터 할당됨  

#### 스택과 힙  
스택과 힙은 런타임 단계에서 메모리를 할당받는 동적 할당  
* 스택(stack)  
지역 변수, 매개 변수, 실행되는 함수에 의해 늘어나거나 줄어드는 메모리 영역  
* 힙(heap)  
동적으로 할당되는 변수를 담음  
동적으로 관리되는 자료구조를 담음  

#### 데이터 영역과 코드 영역  
데이터 영역과 코드 영역은 컴파일 단계에서 메모리를 할당하는 정적 할당  
* BSS segment  
전역 변수 또는 static, const로 선언되어 있고 0으로 초기화된 변수  
초기화가 어떠한 값으로도 되어있는 않은 변수  
* data segment  
전역 변수 또는 static, const로 선언되어 있고 0이 아닌 값으로 초기화된 변수  
* code segment  
프로그램의 코드  

### 3.3.4 PCB(Process Control Block)  
운영체제에서 프로세스에 대한 메타 데이터를 저장한 데이터  
프로세스가 생성되면 운영체제는 해당 PCB를 생성  

#### PCB의 구조  
* 프로세스 스케줄링 상태: 프로세스가 CPU에 대한 소유권을 얻은 이후의 상태  
* 프로세스 ID: 프로세스 ID, 해당 프로세스의 자식 프로세스 ID  
* 프로세스 권한: 컴퓨터 자원 또는 I/O 디바이스에 대한 권한 정보  
* 프로그램 카운터: 프로세스에서 실행해야 할 다음 명령어의 주소에 대한 포인터  
* CPU 레지스터: 프로세스를 실행하기 위해 저장해야 할 레지스터에 대한 정보  
* CPU 스케줄링 정보: CPU 스케줄러에 의해 중단된 시간 등에 대한 정보  
* 계정 정보: 프로세스 실행에 사용된 CPU 사용량, 실행한 유저의 정보  

#### 컨텍스트 스위칭(context switching)  
PCB를 교환하는 과정  
한 프로세스에 할당된 시간이 끝나거나 인터럽트에 의해 발생  
한 개의 프로세스 A가 실행하다 멈추고, 프로세스 A의 PCB를 저장하고 다시 프로세스 B를 로드하여 실행, 그리고 다시 프로세스 B의 PCB를 저장하고 프로세스 A의 PCB를 로드  
컨텍스트 스위칭이 일어날 때 유휴 시간(idle time) 발생  
컨텍스트 스위칭이 일어날 때 캐시미스에 의한 비용 발생  

##### 비용: 캐시미스  
컨텍스트 스위칭이 일어날 때 프로세스가 가지고 있는 메모리 주소가 그대로 있으면 잘못된 주소 변환이 생기므로 캐시클리어 과정을 겪게 되고, 이 때문에 캐시미스 발생  

##### 스레드에서의 컨텍스트 스위칭  
스레드는 스택 영역을 제외한 모든 메모리를 공유하기 때문에 스레드 컨텍스트 스위칭의 경우 비용이 더 적고 시간도 더 적게 걸림  

### 3.3.5 멀티프로세싱  
여러 개의 **프로세스**, 즉 멀티프로세스를 통해 동시에 두 가지 이상의 일을 수행할 수 있는 것  
하나 이사으이 일을 병렬로 처리할 수 있음  
특정 프로세스의 메모리, 프로세스 중 일부에 문제가 발생되더라도 다른 프로세스를 이용해서 처리할 수 있으므로 신뢰성이 높음  

#### 웹 브라우저  
웹 브라우저는 멀티프로세스 구조를 가지고 있음  
* 브라우저 프로세스: 주소 표시줄, 북마크 막대, 뒤로 가기 버튼, 앞으로 가기 버튼 등을 담당하며 네트워크 요청이나 파일 접근 같은 권한을 담당  
* 랜더러 프로세스: 웹 사이트가 보이는 부분의 모든 것을 제어  
* 플러그인 프로세스: 웹 사이트에서 사용하는 플러그인을 제어  
* GPU 프로세스: GPU를 이용해서 화면을 그리는 부분을 제어  

#### IPC(Inter Process Communication)  
멀티프로세스는 IPC가 가능하며 IPC는 프로세스끼리 데이터를 주고받고 공유 데이터를 관리하는 메커니즘  
IPC의 종류로는 **공유 메모리**, **파일**, **소켓**, **익명 파이프**, **명명 파이프**, **메시지 큐**가 있음  
메모리가 완전히 공유되는 스레드보다는 속도가 떨어짐  

##### 공유 메모리(shared memory)  
여러 프로세스에 동일한 메모리 블록에 대한 접근 권한이 부여  
프로세스가 서로 통신할 수 있도록 공유 메모리를 생성해서 통신  
기본적으로는 각 프로세스의 메모리를 다른 프로세스가 접근할 수 없지만 공유 메모리를 통해 여러 프로세스가 하나의 메모리를 공유할 수 있음  
메모리 자체를 공유하기 때문에 불필요한 데이터 복사의 오버헤드가 발생하지 않아 IPC 방식 중 가장 빠름  
같은 메모리 영역을 여러 프로세스가 공유하기 때문에 동기화가 필요  

##### 파일(file)  
디스크에 저장된 데이터 또는 파일 서버에서 제공한 데이터  
파일을 기반으로 프로세스 간 통신을 함  

##### 소켓(socket)  
동일한 컴퓨터의 다른 프로세스나 네트워크의 다른 컴퓨터로 네이트워크 인터페이스를 통해 전송하는 데이터  

##### 익명 파이프(unamed pipe)  
프로세스 간의 FIFO 방식으로 읽히는 임시 공간인 파이프를 기반으로 데이터를 주고 받음  
단방향 방식의 읽기 전용, 쓰기 전용 파이프를 만들어서 작동하는 방식  
부모, 자식 프로세스 간에만 사용할 수 있으며 다른 네트워크상에서는 사용이 불가능  

##### 명명된 파이프(named pipe)  
파이프 서버와 하나 이사으이 파이프 클라이언트 간의 통신을 위한 명명된 단방향 또는 양방향 파이프  
클라이언트/서버 통신을 위한 별도의 파이프를 제공  
여러 파이프를 동시에 사용할 수 있음  
컴퓨터의 프로세스끼리 또는 다른 네트워크상의 컴퓨터와도 통신을 할 수 있음  
보통 서버용 파이프와 클라이언트용 파이프로 구분해서 작동하며 하나의 인스턴스를 열거나 여러 개의 인스턴스를 기반으로 통신  

##### 메시지 큐(message queue)  
메시지를 큐 데이터 구조 형태로 관리  
커널의 전역변수 형태 등 커널에서 전역적으로 관리  
다른 IPC 방식ㅁ에 비해서 사용 방법이 매우 직관적이고 간단  
간단하게 메시지 큐에 접근할 수 있다는 장점이 있음  
공유 메모리를 통해 IPC를 구현할 때 쓰기 및 읽기 빈도가 높으면 동기화 때문에 기능을 구현하는 것이 매우 복잡해지는데, 이때 대안으로 메시지 큐를 사용하기도 함  

### 3.3.6 스레드와 멀티스레딩  
#### 스레드(thread)  
프로세스의 실행 가능한 가장 작은 단위  
프로세스는 여러 스레드를 가질 수 있음  
코드, 데이터, 스택, 힙을 각각 생성하는 프로세스와는 달리 스레드는 코드, 데이터, 힙은 스레드끼리 서로 공유  
#### 멀티스레딩  
프로세스 내 작업을 여러 개의 스레드, 멀티스레드로 처리하는 기법  
스레드끼리 서로 자원을 공유하기 때문에 효율성이 높음  
중단되지 않은 빠른 처리가 가능  
통시성에 큰 장점  
한 스레드에 문제가 생기면 다른 스레드에도 영향을 끼쳐 스레드로 이루어져 있는 프로세스에 영향을 줄 수 있는 단점이 있음  

### 3.3.7 공유 자원과 임계 영역  
#### 공유 자원(shared resource)  
시스템 안에서 각 프로세스, 스레드가 함께 접근할 수 있는 모니터, 프린터, 메모리. 파일, 데이터 등의 자원이나 변수 등을 의미  
공유 자원을 두 개 이상의 프로세스가 동시에 읽거나 쓰는 상황을 경쟁 상태(race condition)라고 함  
동시에 접근을 시도할 때 접근의 타이밍이나 순서 등이 결괏값에 영향을 줄 수 있는 상태  
#### 임계 영역(critical section)  
둘 이상의 프로세스, 스레드가 공유 자원에 접근할 때 순서 등의 이유로 결과가 달라지는 코드 영역  
임계 영역을 해결하기 위한 방법은 크게 **뮤텍스**, **세마포어**, **모니터** 세 가지가 있음  
이 방법 모두 아래의 조건을 만족  
* 상호 배제: 한 프로세스가 임계 영역에 들어갔을 때 다른 프로세스는 들어갈 수 없음  
* 한정 대기: 특정 프로세스가 영원히 임계 영역에 들어가지 못하면 안됨  
* 융통성: 한 프로세스가 다른 프로세스의 일을 방해해서는 안됨  

##### 뮤텍스(mutex)  
프로세스나 스레드가 공유 자원을 lock()을 통해 잠금 설정하고 사용한 후에는 unlock()을 통해 잠금 해제하는 객체  
잠금이 설정되면 다른 프로세스나 스레드는 잠긴 코드 영역에 접근할 수 없고 해제는 그와 반대  
잠금을 기반으로 상호 배제가 일어나는 **잠금 메커니즘**  

##### 세마포어(semaphore)  
일반화된 뮤텍스  
간단한 정수 값과 두 가지 함수 wait(P 함수), signal(V 함수)로 공유 자원에 대한 접근을 처리  
wait()는 자신의 차례가 올 때까지 기다리는 함수, signal()은 다음 프로세스로 순서를 넘겨주는 함수  
세마포어에는 조건 변수가 없고 프로세스나 스레드가 세마포어 값을 수정할 때 다른 프로세스나 스레드는 동시에 세마포어 값을 수정할 수 없음  
신호를 기반으로 상호 배제가 일어나는 **신호 메커니즘**

##### 바이너리 세마포어  
0과 1의 두 가지 값만 가질 수 있는 세마포어  

#### 카운팅 세마포어  
카운팅 세마포어는 여러 개의 값을 가질 수 있는 세마포어  
여러 자원에 대한 접근을 제어하는 데 사용  

##### 모니터  
둘 이상의 스레드나 프로세스가 공유 자원에 안전하게 접근할 수 있도록 공유 자원을 숨기고 해당 접근에 대한 인터페이스만 제공  
모니터는 모니터큐를 통해 공유 자원에 대한 작업들을 순차적으로 처리  

### 3.3.8 교착 상태(deadlock)  
두 개 이상의 프로세스들이 서로가 가진 자원을 기다리며 중단된 상태  

#####

